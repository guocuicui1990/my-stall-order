<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å®¶åå° - å®æ—¶è®¢å•ç®¡ç†</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- å•†å®¶é…ç½®æ–‡ä»¶ -->
    <script src="config.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .admin-header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .admin-header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* å–é¤ç é‡ç½®åŒºåŸŸæ ·å¼ */
        .sequence-reset-area {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .reset-sequence-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }
        
        .reset-sequence-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        
        .reset-sequence-btn:active {
            transform: translateY(0);
        }

        .auto-refresh {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .refresh-status {
            font-size: 13px;
            color: #666;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-disconnected {
            background: #ffebee;
            color: #c62828;
        }

        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-badge {
            background: #ff4757;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .tab.active .tab-badge {
            background: white;
            color: #667eea;
        }

        .orders-container {
            min-height: 400px;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
            border: 1px solid #f0f0f0;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .new-order-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: none;
            max-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: auto;
        }

        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
        }

        .floating-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .empty-cart {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-cart i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* æœ¬åœ°è®¢å•æ ·å¼ */
        .local-order-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #856404;
        }
        
        /* è®¢å•çŠ¶æ€æŒ‰é’® */
        .order-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-start {
            background: #ff9800;
            color: white;
        }
        
        .btn-complete {
            background: #4CAF50;
            color: white;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
        }
        
        .btn-start:hover {
            background: #f57c00;
        }
        
        .btn-complete:hover {
            background: #388e3c;
        }
        
        .btn-cancel:hover {
            background: #d32f2f;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(244, 67, 54, 0.3);
        }
        
        .btn-cancel:active {
            transform: translateY(0);
        }
        
        /* äº‘ç«¯è¿æ¥æµ‹è¯•åŒºåŸŸ */
        .connection-test {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .test-btn {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
        }
        
        .test-btn-primary {
            background: #667eea;
            color: white;
        }
        
        .test-btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        /* æ¸…ç©ºæŒ‰é’®æ ·å¼ */
        .clear-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            color: white;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* æ¨èç®¡ç†æ ·å¼ */
        .recommend-management {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .recommend-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-size: 13px;
            color: #495057;
            font-weight: 500;
        }
        
        .form-group input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .recommend-list {
            margin-top: 20px;
        }
        
        .recommend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .recommend-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .recommend-info {
            flex: 1;
        }
        
        .recommend-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }
        
        .recommend-price {
            color: #ff6b6b;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .recommend-description {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .recommend-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit, .btn-delete {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .btn-edit {
            background: #4CAF50;
            color: white;
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
        }
        
        .btn-edit:hover {
            background: #388e3c;
        }
        
        .btn-delete:hover {
            background: #d32f2f;
        }
        
        /* æ·»åŠ æ¨èç®¡ç†æ ‡ç­¾é¡µ */
        .recommend-tab {
            position: relative;
        }
        
        .recommend-tab .tab-badge {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* å•†å®¶é€‰æ‹©å™¨æ ·å¼ */
        .shop-selector {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .shop-selector label {
            font-size: 13px;
            color: #495057;
            font-weight: 500;
        }
        
        .shop-selector select {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
            background: white;
            cursor: pointer;
        }
        
        .shop-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .current-shop-display {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .current-shop-display i {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-header-content">
                <h1>
                    <i class="fas fa-store"></i> å•†å®¶åå° - å®æ—¶è®¢å•ç®¡ç†
                </h1>
                <p>
                    <span class="connection-status status-connected" id="connectionStatus">
                        <i class="fas fa-circle"></i> æ­£åœ¨è¿æ¥...
                    </span>
                    &nbsp;&nbsp;è®¢å•è‡ªåŠ¨åŒæ­¥ï¼Œå•†å®¶ç«¯å¯è·¨ç½‘ç»œå®æ—¶æŸ¥çœ‹
                </p>
                
                <!-- å•†å®¶æ˜¾ç¤ºï¼ˆä¸å†æä¾›åˆ‡æ¢åŠŸèƒ½ï¼‰ -->
                <div class="shop-selector">
                    <div class="current-shop-display" id="currentShopDisplay">
                        <i class="fas fa-store"></i> å½“å‰å•†å®¶: <strong><span id="currentShopName">æˆ‘çš„æ‘Šä½</span></strong>
                        <span style="color: #666; font-size: 12px; margin-left: 10px;">
                            ï¼ˆç‹¬ç«‹åå°ï¼Œæ— æ³•åˆ‡æ¢å…¶ä»–å•†å®¶ï¼‰
                        </span>
                    </div>
                </div>
                
                <!-- å¯¼èˆªé“¾æ¥å·²è¢«ç§»é™¤ -->
                
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalOrders">0</div>
                        <div class="stat-label">æ€»è®¢å•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="newOrders">0</div>
                        <div class="stat-label">æ–°è®¢å•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="processingOrders">0</div>
                        <div class="stat-label">å¤„ç†ä¸­</div>
                    </div>
                    <div class="stat-card" style="position: relative;">
                        <div class="stat-value" id="todayRevenue">0</div>
                        <div class="stat-label">ä»Šæ—¥è¥æ”¶</div>
                        <!-- ğŸ”¥ æ·»åŠ æ¸…ç©ºæŒ‰é’® -->
                        <button class="clear-btn" onclick="clearTodayStats()" title="æ¸…ç©ºä»Šæ—¥æ•°æ®">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- å–é¤ç é‡ç½®åŒºåŸŸ -->
                <div class="sequence-reset-area" style="margin-top: 15px;">
                    <button class="reset-sequence-btn" onclick="resetSequenceNumber()" title="é‡ç½®å–é¤ç ">
                        <i class="fas fa-redo-alt"></i> é‡ç½®å–é¤ç 
                    </button>
                    <span style="font-size: 12px; color: #666; margin-left: 10px;">
                        å½“å‰: <span id="currentSequenceDisplay">A001</span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Supabaseè¿æ¥æµ‹è¯•åŒºåŸŸ -->
        <div class="connection-test">
            <h3 style="margin-bottom: 10px; font-size: 14px; color: #333;">
                <i class="fas fa-network-wired"></i> Supabaseè¿æ¥æµ‹è¯•
            </h3>
            <div id="connectionTestResult" style="font-size: 13px; margin-bottom: 10px;">
                Supabase URL: <code id="supabaseUrlDisplay">slonbvmhsxqgpoodwazj.supabase.co</code> | çŠ¶æ€: <span id="testStatus">ç­‰å¾…æµ‹è¯•</span>
            </div>
            <div class="test-buttons">
                <button class="test-btn test-btn-primary" onclick="testConnection()">
                    <i class="fas fa-bolt"></i> æµ‹è¯•è¿æ¥
                </button>
                <button class="test-btn test-btn-secondary" onclick="createTestOrder()">
                    <i class="fas fa-plus"></i> åˆ›å»ºæµ‹è¯•è®¢å•
                </button>
                <button class="test-btn test-btn-secondary" onclick="showLocalOrders()">
                    <i class="fas fa-database"></i> æŸ¥çœ‹æœ¬åœ°è®¢å•
                </button>
            </div>
        </div>
        
        <!-- æœ¬åœ°è®¢å•æé†’ -->
        <div class="local-order-notice" id="localModeNotice" style="display: none;">
            <i class="fas fa-info-circle"></i> 
            <strong>æœ¬åœ°æ¨¡å¼æé†’ï¼š</strong>å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œè®¢å•ä¸ä¼šä¿å­˜åˆ°äº‘ç«¯ã€‚å¦‚éœ€ä½¿ç”¨äº‘ç«¯åŒæ­¥åŠŸèƒ½ï¼Œè¯·æ£€æŸ¥Supabaseé…ç½®ã€‚
        </div>
        
        <div class="auto-refresh">
            <h3 style="margin-bottom: 15px; font-size: 14px; color: #333;">
                <i class="fas fa-info-circle"></i> å®æ—¶åŒæ­¥è¯´æ˜
            </h3>
            <div class="refresh-controls">
                <div class="refresh-status">
                    ä½¿ç”¨Supabaseæ•°æ®åº“ï¼Œè®¢å•å®æ—¶åŒæ­¥ | æœ€åæ›´æ–°: <span id="lastUpdateTime">-</span>
                </div>
            </div>
        </div>
        
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('new')" data-tab="new">
                    <i class="fas fa-bell"></i> æ–°è®¢å•
                    <span class="tab-badge" id="newOrdersBadge">0</span>
                </button>
                <button class="tab" onclick="switchTab('processing')" data-tab="processing">
                    <i class="fas fa-clock"></i> å¤„ç†ä¸­
                    <span class="tab-badge" id="processingOrdersBadge">0</span>
                </button>
                <button class="tab" onclick="switchTab('completed')" data-tab="completed">
                    <i class="fas fa-check"></i> å·²å®Œæˆ
                    <span class="tab-badge" id="completedOrdersBadge">0</span>
                </button>
                <button class="tab recommend-tab" onclick="switchTab('recommend')" data-tab="recommend">
                    <i class="fas fa-star"></i> æ¨èç®¡ç†
                    <span class="tab-badge" id="recommendCount">0</span>
                </button>
                <button class="tab" onclick="switchTab('all')" data-tab="all">
                    <i class="fas fa-list"></i> å…¨éƒ¨è®¢å•
                </button>
            </div>
        </div>
        
        <!-- æ¨èç®¡ç†é¡µé¢ -->
        <div class="recommend-management" id="recommendPage" style="display: none;">
            <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-star"></i> ä»Šæ—¥æ¨èç®¡ç† - <span id="recommendShopName">æˆ‘çš„æ‘Šä½</span>
            </h3>
            
            <div class="recommend-form">
                <div class="form-group">
                    <label for="recommendName">èœå“åç§° *</label>
                    <input type="text" id="recommendName" placeholder="ä¾‹å¦‚ï¼šæ‹›ç‰Œç‚¸é…±é¢" maxlength="20">
                </div>
                
                <div class="form-group">
                    <label for="recommendPrice">ä»·æ ¼ *</label>
                    <input type="number" id="recommendPrice" placeholder="ä¾‹å¦‚ï¼š15" min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="recommendDesc">æè¿°/å¤‡æ³¨</label>
                    <input type="text" id="recommendDesc" placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥ç‰¹æƒ " maxlength="30">
                </div>
                
                <div class="form-group">
                    <label for="recommendSort">æ’åºåºå·</label>
                    <input type="number" id="recommendSort" placeholder="æ•°å­—è¶Šå°è¶Šé å‰" min="0" value="0">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="test-btn test-btn-primary" onclick="saveRecommendation()">
                        <i class="fas fa-save"></i> ä¿å­˜æ¨è
                    </button>
                    <button class="test-btn test-btn-secondary" onclick="clearRecommendForm()">
                        <i class="fas fa-times"></i> æ¸…ç©º
                    </button>
                </div>
            </div>
            
            <div class="recommend-list" id="recommendList">
                <div class="empty-cart">
                    <i class="fas fa-star"></i>
                    <p>æš‚æ— æ¨èèœå“</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">æ·»åŠ çš„æ¨èèœå“å°†æ˜¾ç¤ºåœ¨é¡¾å®¢ç«¯é¦–é¡µ</p>
                </div>
            </div>
        </div>
        
        <div class="orders-container" id="ordersContainer">
            <div class="empty-cart">
                <i class="fas fa-spinner fa-spin"></i>
                <p>æ­£åœ¨è¿æ¥äº‘ç«¯...</p>
            </div>
        </div>
        
        <div class="new-order-notification" id="newOrderNotification">
            <div class="notification-content">
                <i class="fas fa-bell" style="font-size: 18px;"></i>
                <div>
                    <div style="font-weight: 600; margin-bottom: 3px;">æ–°è®¢å•æé†’</div>
                    <div style="font-size: 12px;" id="notificationMessage">æœ‰æ–°è®¢å•åˆ°è¾¾ï¼</div>
                </div>
                <button class="notification-close" onclick="hideNotification()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="floating-actions">
            <button class="floating-btn" onclick="loadOrders()" title="ç«‹å³åˆ·æ–°">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ============================================
        // å…¨å±€å˜é‡å’Œé…ç½® - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        let currentTab = 'new';
        let allOrders = [];
        let allRecommendations = [];
        let realtimeSubscription = null;
        let isCloudMode = false;
        let editingRecommendId = null;
        let currentShopId = ''; // å½“å‰å•†å®¶ID
        let currentShopConfig = null; // å½“å‰å•†å®¶é…ç½®
        
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://slonbvmhsxqgpoodwazj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb25idm1oc3hxZ3Bvb2R3YXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzMyNjQsImV4cCI6MjA4NDYwOTI2NH0.YLZqdnZl1vDTOrT6bzi2ulN1BGRxKGyW30AuccuWJq4';
        
        let supabaseClient = null;
        let localOrders = JSON.parse(localStorage.getItem('localOrders') || '[]');
        
        // ============================================
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ å•†å®¶åå°åˆå§‹åŒ–...');
            
            // 1. è·å–å½“å‰å•†å®¶é…ç½®
            currentShopId = getCurrentShopId();
            currentShopConfig = getCurrentShopConfig();
            
            console.log('ğŸª å½“å‰å•†å®¶:', currentShopConfig.name, 'ID:', currentShopId);
            
            // 2. æ›´æ–°é¡µé¢æ˜¾ç¤º
            updateShopDisplay();
            
            // 3. æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = `${currentShopConfig.name} - å•†å®¶åå°`;
            
            // 4. æ˜¾ç¤ºSupabase URL
            document.getElementById('supabaseUrlDisplay').textContent = 'slonbvmhsxqgpoodwazj.supabase.co';
            
            // 5. å°è¯•è¿æ¥Supabase
            await initSupabase();
            
            // 6. åŠ è½½è®¢å•
            await loadOrders();
            
            // 7. åŠ è½½æ¨èèœå“
            await loadRecommendations();
            
            // 8. åŠ è½½å½“å‰å–é¤ç 
            await loadCurrentSequence();
            
            console.log('âœ… å•†å®¶åå°åˆå§‹åŒ–å®Œæˆ');
        });
        
        // ============================================
        // æ›´æ–°å•†å®¶æ˜¾ç¤º
        // ============================================
        function updateShopDisplay() {
            // æ›´æ–°å½“å‰å•†å®¶æ˜¾ç¤º
            document.getElementById('currentShopName').textContent = currentShopConfig.name;
            
            // æ›´æ–°æ¨èç®¡ç†é¡µé¢çš„å•†å®¶åç§°
            const recommendShopName = document.getElementById('recommendShopName');
            if (recommendShopName) {
                recommendShopName.textContent = currentShopConfig.name;
            }
        }
        
        // ============================================
        // åˆå§‹åŒ–Supabase - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function initSupabase() {
            try {
                console.log('ğŸŒ å•†å®¶ç«¯è¿æ¥Supabase...');
                
                // æ£€æŸ¥supabaseæ˜¯å¦å·²åŠ è½½
                if (typeof supabase === 'undefined') {
                    console.error('âŒ Supabase SDK æœªåŠ è½½');
                    updateConnectionStatus(false, 'SDKæœªåŠ è½½');
                    return;
                }
                
                // 1. åˆå§‹åŒ–å®¢æˆ·ç«¯
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                
                // 2. æµ‹è¯•è¿æ¥ - åŠ ä¸Štenant_idæ¡ä»¶
                console.log('ğŸ“Š æµ‹è¯•æ•°æ®åº“è¿æ¥...');
                try {
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .eq('tenant_id', currentShopId) // å¤šå•†å®¶æ”¯æŒ
                        .limit(1);
                    
                    if (error) {
                        console.error('âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error.message);
                        
                        if (error.message.includes('relation') || error.message.includes('ä¸å­˜åœ¨')) {
                            updateConnectionStatus(false, 'è¡¨ä¸å­˜åœ¨');
                            showToast('âŒ ordersè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåœ¨Supabaseåˆ›å»ºordersè¡¨', 'error');
                        } else {
                            updateConnectionStatus(false, 'è¿æ¥å¤±è´¥');
                        }
                    } else {
                        console.log('âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸï¼Œå·²æœ‰è®¢å•æ•°:', data.length);
                        
                        isCloudMode = true;
                        updateConnectionStatus(true, 'äº‘ç«¯å·²è¿æ¥');
                        
                        // å¯åŠ¨å®æ—¶ç›‘å¬
                        setupRealtimeWatch();
                    }
                    
                } catch (dbError) {
                    console.error('âŒ æ•°æ®åº“è¿æ¥æµ‹è¯•å¼‚å¸¸:', dbError.message);
                    updateConnectionStatus(false, 'è¿æ¥å¼‚å¸¸');
                    showToast('âŒ Supabaseè¿æ¥å¼‚å¸¸: ' + dbError.message, 'error');
                }
                
            } catch (error) {
                console.error('âŒ Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
                updateConnectionStatus(false, error.message);
                showToast('âŒ Supabaseè¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ============================================
        // è®¾ç½®å®æ—¶ç›‘å¬ï¼ˆäº‘ç«¯æ¨¡å¼ï¼‰- å¤šå•†å®¶æ”¯æŒ
        // ============================================
        function setupRealtimeWatch() {
            if (!isCloudMode || !supabaseClient) {
                console.log('ğŸ“ æ— æ³•å¯åŠ¨å®æ—¶ç›‘å¬ï¼Œå½“å‰ä¸ºæœ¬åœ°æ¨¡å¼');
                return;
            }
            
            try {
                console.log('ğŸ“¡ å¯åŠ¨å®æ—¶è®¢å•ç›‘å¬...');
                
                // å…³é—­ä¹‹å‰çš„è®¢é˜…ï¼ˆå¦‚æœæœ‰ï¼‰
                if (realtimeSubscription) {
                    supabaseClient.removeChannel(realtimeSubscription);
                }
                
                // åˆ›å»ºæ–°çš„è®¢é˜… - ç›‘å¬å½“å‰å•†å®¶çš„è®¢å•
                realtimeSubscription = supabaseClient
                    .channel('orders-channel')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'orders',
                            filter: `tenant_id=eq.${currentShopId}` // å¤šå•†å®¶æ”¯æŒï¼šåªç›‘å¬å½“å‰å•†å®¶
                        }, 
                        (payload) => {
                            console.log('ğŸ“¡ æ£€æµ‹åˆ°æ–°è®¢å•:', payload.new);
                            console.log('äº‹ä»¶ç±»å‹: INSERT');
                            
                            // é‡æ–°åŠ è½½è®¢å•
                            loadOrders();
                            
                            // æ˜¾ç¤ºæ–°è®¢å•é€šçŸ¥
                            showNewOrderNotification(1);
                        }
                    )
                    .on('postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'orders',
                            filter: `tenant_id=eq.${currentShopId}` // å¤šå•†å®¶æ”¯æŒï¼šåªç›‘å¬å½“å‰å•†å®¶
                        },
                        (payload) => {
                            console.log('ğŸ“¡ æ£€æµ‹åˆ°è®¢å•æ›´æ–°:', payload.new);
                            console.log('äº‹ä»¶ç±»å‹: UPDATE');
                            
                            // é‡æ–°åŠ è½½è®¢å•
                            loadOrders();
                        }
                    )
                    .subscribe((status) => {
                        console.log('ğŸ“¡ å®æ—¶è®¢é˜…çŠ¶æ€:', status);
                        
                        if (status === 'SUBSCRIBED') {
                            console.log('âœ… å®æ—¶ç›‘å¬å·²å¯åŠ¨');
                            showToast('âœ… å®æ—¶ç›‘å¬å·²å¯åŠ¨ï¼Œç­‰å¾…æ–°è®¢å•...', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('âŒ å®æ—¶ç›‘å¬é€šé“é”™è¯¯');
                            updateConnectionStatus(false, 'ç›‘å¬æ–­å¼€');
                        } else if (status === 'TIMED_OUT') {
                            console.error('âŒ å®æ—¶ç›‘å¬è¶…æ—¶');
                            updateConnectionStatus(false, 'ç›‘å¬è¶…æ—¶');
                        }
                    });
                
            } catch (error) {
                console.error('âŒ å¯åŠ¨å®æ—¶ç›‘å¬å¤±è´¥:', error);
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨è½®è¯¢
                console.log('ğŸ“Œ ä½¿ç”¨è½®è¯¢æ¨¡å¼ï¼ˆæ¯5ç§’åˆ·æ–°ï¼‰');
                setInterval(() => loadOrders(), 5000);
            }
        }
        
        // ============================================
        // é‡ç½®å–é¤ç å‡½æ•° - å¤šå•†å®¶æ”¯æŒï¼ˆç‹¬ç«‹é‡ç½®ï¼‰
        // ============================================
        async function resetSequenceNumber() {
            if (!confirm('âš ï¸ ç¡®å®šè¦é‡ç½®å–é¤ç å—ï¼Ÿ\n\nè¿™å°†ï¼š\n1. é‡ç½®å–é¤ç åºåˆ—ä¸º A001\n2. å½“å‰å•†å®¶çš„é¡¾å®¢ç«¯å°†ç«‹å³æ›´æ–°\n3. ä¸ä¼šå½±å“å…¶ä»–å•†å®¶\n4. å»ºè®®åœ¨è¥ä¸šå¼€å§‹å‰æ“ä½œ')) {
                return;
            }
            
            try {
                console.log('ğŸ”„ å¼€å§‹é‡ç½®å–é¤ç ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰...');
                
                if (!isCloudMode || !supabaseClient) {
                    showToast('å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œæ— æ³•é‡ç½®å–é¤ç ', 'warning');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½ä¸­
                showToast('æ­£åœ¨é‡ç½®å–é¤ç ...', 'info');
                
                // æ›´æ–°å–é¤ç é…ç½® - ä»…å½“å‰å•†å®¶
                const { error: prefixError } = await supabaseClient
                    .from('settings')
                    .update({ 
                        setting_value: 'A',
                        updated_at: new Date().toISOString()
                    })
                    .eq('setting_key', 'sequence_prefix')
                    .eq('tenant_id', currentShopId); // ä»…å½“å‰å•†å®¶
                
                if (prefixError) throw prefixError;
                
                const { error: counterError } = await supabaseClient
                    .from('settings')
                    .update({ 
                        setting_value: '1',
                        updated_at: new Date().toISOString()
                    })
                    .eq('setting_key', 'sequence_counter')
                    .eq('tenant_id', currentShopId); // ä»…å½“å‰å•†å®¶
                
                if (counterError) throw counterError;
                
                console.log('âœ… å–é¤ç é‡ç½®æˆåŠŸï¼ˆå•†å®¶:', currentShopId, 'ï¼‰');
                showToast('âœ… å–é¤ç å·²é‡ç½®ä¸º A001ï¼Œé¡¾å®¢ç«¯å°†è‡ªåŠ¨æ›´æ–°', 'success');
                
                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('currentSequenceDisplay').textContent = 'A001';
                
            } catch (error) {
                console.error('âŒ é‡ç½®å–é¤ç å¤±è´¥:', error);
                showToast('âŒ é‡ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ============================================
        // åŠ è½½å½“å‰å–é¤ç çŠ¶æ€ - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function loadCurrentSequence() {
            if (!isCloudMode || !supabaseClient) {
                document.getElementById('currentSequenceDisplay').textContent = 'A001';
                return;
            }
            
            try {
                console.log('ğŸ”¢ åŠ è½½å½“å‰å–é¤ç ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰...');
                
                // åŒæ—¶è·å–å‰ç¼€å’Œè®¡æ•°å™¨
                const [prefixResult, counterResult] = await Promise.all([
                    supabaseClient
                        .from('settings')
                        .select('setting_value')
                        .eq('setting_key', 'sequence_prefix')
                        .eq('tenant_id', currentShopId)
                        .maybeSingle(), // ä½¿ç”¨maybeSingleé¿å…é”™è¯¯
                    
                    supabaseClient
                        .from('settings')
                        .select('setting_value')
                        .eq('setting_key', 'sequence_counter')
                        .eq('tenant_id', currentShopId)
                        .maybeSingle()
                ]);
                
                const prefix = prefixResult.data?.setting_value || 'A';
                const counter = counterResult.data?.setting_value || '1';
                const currentSeq = prefix + counter.padStart(3, '0');
                
                console.log('ğŸ“Š å½“å‰å–é¤ç ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰:', currentSeq);
                document.getElementById('currentSequenceDisplay').textContent = currentSeq;
                
            } catch (error) {
                console.error('âŒ åŠ è½½å½“å‰å–é¤ç å¤±è´¥:', error);
                document.getElementById('currentSequenceDisplay').textContent = 'A001';
            }
        }
        
        // ============================================
        // åŠ è½½è®¢å•ï¼ˆå®Œå…¨é€‚é…ä½ çš„è¡¨ç»“æ„ï¼‰- å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function loadOrders() {
            try {
                showLoading();
                
                if (isCloudMode && supabaseClient) {
                    // äº‘ç«¯æ¨¡å¼ - åªåŠ è½½å½“å‰å•†å®¶çš„è®¢å•
                    console.log('ğŸŒ ä»SupabaseåŠ è½½è®¢å•ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰...');
                    
                    const { data, error } = await supabaseClient
                        .from('orders')
                        .select('*')
                        .eq('tenant_id', currentShopId) // å¤šå•†å®¶æ”¯æŒï¼šåªè·å–å½“å‰å•†å®¶çš„è®¢å•
                        .order('timestamp', { ascending: false })
                        .limit(100);
                    
                    if (error) {
                        console.error('âŒ ä»SupabaseåŠ è½½è®¢å•å¤±è´¥:', error);
                        throw new Error(error.message);
                    }
                    
                    console.log('âœ… ä»äº‘ç«¯åŠ è½½åˆ°', data.length, 'ä¸ªè®¢å•ï¼ˆå•†å®¶:', currentShopId, ')');
                    
                    // è½¬æ¢å­—æ®µåï¼Œå®Œå…¨é€‚é…ä½ çš„è¡¨ç»“æ„
                    allOrders = data.map(order => {
                        const hasId = order.id !== undefined;
                        
                        return {
                            _id: hasId ? order.id : order.order_number,
                            id: hasId ? order.id : order.order_number,
                            orderNumber: order.order_number,
                            table: order.table,
                            dishes: order.dishes,
                            totalAmount: order.total_amount,
                            status: order.status || 'æ–°è®¢å•',
                            orderTime: order.order_time,
                            timestamp: order.timestamp || Date.now(),
                            source: 'é¡¾å®¢æ‰«ç ç‚¹é¤',
                            tenant_id: order.tenant_id, // ä¿å­˜å•†å®¶ID
                            _raw: order
                        };
                    });
                    
                } else {
                    // æœ¬åœ°æ¨¡å¼ - è¿‡æ»¤å½“å‰å•†å®¶çš„è®¢å•
                    console.log('ğŸ“ åŠ è½½æœ¬åœ°è®¢å•ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰...');
                    
                    // æ˜¾ç¤ºæœ¬åœ°æ¨¡å¼æé†’
                    const notice = document.getElementById('localModeNotice');
                    if (notice) notice.style.display = 'block';
                    
                    // è¿‡æ»¤å½“å‰å•†å®¶çš„è®¢å•
                    allOrders = localOrders.filter(order => order.tenant_id === currentShopId);
                    console.log('æœ¬åœ°è®¢å•æ•°ï¼ˆå•†å®¶', currentShopId, 'ï¼‰:', allOrders.length);
                }
                
                // æ›´æ–°æ˜¾ç¤º
                displayOrders();
                updateStats();
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('âŒ åŠ è½½è®¢å•å¤±è´¥:', error);
                console.log('é”™è¯¯è¯¦æƒ…:', error.message);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const container = document.getElementById('ordersContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>åŠ è½½å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
                            <button onclick="loadOrders()" style="margin-top: 15px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                é‡è¯•
                            </button>
                        </div>
                    `;
                }
                
                updateConnectionStatus(false, 'åŠ è½½å¤±è´¥');
            }
        }
        
        // ============================================
        // æ˜¾ç¤ºè®¢å•åˆ—è¡¨ - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        function displayOrders() {
            let filteredOrders = [];
            
            // æ ¹æ®æ ‡ç­¾é¡µç­›é€‰
            if (currentTab === 'new') {
                filteredOrders = allOrders.filter(o => o.status === 'æ–°è®¢å•');
                console.log('æ–°è®¢å•åˆ—è¡¨ï¼ˆå•†å®¶', currentShopId, 'ï¼‰:', filteredOrders.length, 'ä¸ª');
            } else if (currentTab === 'processing') {
                filteredOrders = allOrders.filter(o => o.status === 'å¤„ç†ä¸­');
                console.log('å¤„ç†ä¸­åˆ—è¡¨ï¼ˆå•†å®¶', currentShopId, 'ï¼‰:', filteredOrders.length, 'ä¸ª');
            } else if (currentTab === 'completed') {
                filteredOrders = allOrders.filter(o => o.status === 'å·²å®Œæˆ');
            } else {
                filteredOrders = allOrders;
            }
            
            const container = document.getElementById('ordersContainer');
            if (!container) return;
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-inbox"></i>
                        <p>æš‚æ— ${currentTab === 'all' ? '' : currentTab === 'new' ? 'æ–°' : currentTab === 'processing' ? 'å¤„ç†ä¸­çš„' : 'å·²å®Œæˆçš„'}è®¢å•</p>
                        ${!isCloudMode ? '<p style="font-size: 12px; color: #999; margin-top: 10px;">å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œä»…æ˜¾ç¤ºæœ¬åœ°å­˜å‚¨çš„è®¢å•</p>' : ''}
                        <p style="font-size: 12px; color: #999; margin-top: 5px;">å½“å‰å•†å®¶: ${currentShopConfig.name}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredOrders.map(order => {
                const orderId = order._id || order.id || Math.random().toString(36).substr(2, 9);
                const isLocalOrder = order.isLocal || !order._id;
                
                return `
                <div class="order-card">
                    <div class="order-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span class="order-number" style="font-weight: 600; font-size: 16px;">
                            <i class="fas fa-hashtag"></i> å–é¤å·: #${order.table}
                            <span style="font-size: 12px; color: #666; margin-left: 10px;">
                                <i class="fas fa-receipt"></i> ${order.orderNumber}
                            </span>
                        </span>
                        <span class="order-status" style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; ${order.status === 'æ–°è®¢å•' ? 'background: #e3f2fd; color: #1976d2;' : order.status === 'å¤„ç†ä¸­' ? 'background: #fff3e0; color: #f57c00;' : 'background: #e8f5e9; color: #388e3c;'}">
                            ${order.status}
                        </span>
                    </div>
                    <div class="order-body">
                        <div class="order-info" style="display: flex; gap: 15px; margin-bottom: 10px; font-size: 13px; color: #666;">
                            <span><i class="fas fa-chair" style="color: #667eea;"></i> æ¡Œå·: <strong>${order.table || 'æœªçŸ¥'}</strong></span>
                            <span><i class="fas fa-clock" style="color: #667eea;"></i> ${order.orderTime || 'æœªçŸ¥æ—¶é—´'}</span>
                        </div>
                        <div class="order-dishes" style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; line-height: 1.6;">
                            ${order.dishes || 'æ— èœå“ä¿¡æ¯'}
                        </div>
                        <div class="order-footer" style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="order-total" style="font-weight: 600; color: #ff6b6b; font-size: 18px;">
                                æ€»è®¡: Â¥${order.totalAmount ? order.totalAmount.toFixed(2) : '0.00'}
                            </div>
                            ${!isLocalOrder && isCloudMode && order.status !== 'å·²å®Œæˆ' && order.status !== 'å·²å–æ¶ˆ' ? `
                            <div class="order-actions" style="display: flex; gap: 8px;">
                                ${order.status === 'æ–°è®¢å•' ? `
                                    <button class="btn-start" onclick="updateOrderStatus('${orderId}', '${order.orderNumber}', 'å¤„ç†ä¸­')">
                                        <i class="fas fa-clock"></i> å¼€å§‹åˆ¶ä½œ
                                    </button>
                                    <button class="btn-cancel" onclick="cancelOrder('${orderId}', '${order.orderNumber}')">
                                        <i class="fas fa-times"></i> æ’¤å•
                                    </button>
                                ` : ''}
                                ${order.status === 'å¤„ç†ä¸­' ? `
                                    <button class="btn-complete" onclick="updateOrderStatus('${orderId}', '${order.orderNumber}', 'å·²å®Œæˆ')">
                                        <i class="fas fa-check"></i> å®Œæˆ
                                    </button>
                                    <button class="btn-cancel" onclick="cancelOrder('${orderId}', '${order.orderNumber}')">
                                        <i class="fas fa-times"></i> æ’¤å•
                                    </button>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        // ============================================
        // æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆå®Œå…¨é€‚é…ä½ çš„è¡¨ç»“æ„ï¼‰- å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function updateOrderStatus(orderId, orderNumber, newStatus) {
            try {
                console.log('ğŸ”„ æ›´æ–°è®¢å•çŠ¶æ€:', orderId, orderNumber, newStatus, 'å•†å®¶:', currentShopId);
                
                if (!isCloudMode || !supabaseClient) {
                    showToast('å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œæ— æ³•æ›´æ–°çŠ¶æ€', 'warning');
                    return;
                }
                
                // æ›´æ–°æ•°æ®
                const updateData = { 
                    status: newStatus,
                    timestamp: Date.now()
                };
                
                console.log('æ›´æ–°æ•°æ®:', updateData);
                
                // ä½¿ç”¨ order_number å’Œ tenant_id æ›´æ–°
                const { error } = await supabaseClient
                    .from('orders')
                    .update(updateData)
                    .eq('order_number', orderNumber)
                    .eq('tenant_id', currentShopId); // å¤šå•†å®¶æ”¯æŒ
                
                if (error) {
                    console.error('âŒ æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                    showToast('âŒ æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                    return;
                }
                
                console.log('âœ… è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ');
                showToast(`âœ… è®¢å•å·²æ›´æ–°ä¸º ${newStatus}`, 'success');
                
                // å…³é”®ä¿®å¤ï¼šç«‹å³é‡æ–°ä»æ•°æ®åº“åŠ è½½æ•°æ®ï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥
                setTimeout(async () => {
                    await loadOrders();
                }, 500);
                
            } catch (error) {
                console.error('âŒ æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                showToast('âŒ æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ============================================
        // æ’¤å•å‡½æ•° - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function cancelOrder(orderId, orderNumber) {
            if (!confirm(`ç¡®å®šè¦æ’¤æ¶ˆè®¢å• #${orderNumber} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }
            
            try {
                console.log('âŒ æ’¤å•:', orderId, orderNumber, 'å•†å®¶:', currentShopId);
                
                if (!isCloudMode || !supabaseClient) {
                    showToast('å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œæ— æ³•æ’¤å•', 'warning');
                    return;
                }
                
                // æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²å–æ¶ˆ"
                const updateData = { 
                    status: 'å·²å–æ¶ˆ',
                    timestamp: Date.now()
                };
                
                console.log('æ’¤å•æ•°æ®:', updateData);
                
                const { error } = await supabaseClient
                    .from('orders')
                    .update(updateData)
                    .eq('order_number', orderNumber)
                    .eq('tenant_id', currentShopId); // å¤šå•†å®¶æ”¯æŒ
                
                if (error) {
                    console.error('âŒ æ’¤å•å¤±è´¥:', error);
                    showToast('âŒ æ’¤å•å¤±è´¥: ' + error.message, 'error');
                    return;
                }
                
                console.log('âœ… æ’¤å•æˆåŠŸ');
                showToast(`âœ… è®¢å• #${orderNumber} å·²å–æ¶ˆ`, 'success');
                
                // åˆ·æ–°æ•°æ®
                setTimeout(async () => {
                    await loadOrders();
                }, 500);
                
            } catch (error) {
                console.error('âŒ æ’¤å•å¤±è´¥:', error);
                showToast('âŒ æ’¤å•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ============================================
        // æ›´æ–°ç»Ÿè®¡æ•°æ® - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        function updateStats() {
            const newCount = allOrders.filter(o => o.status === 'æ–°è®¢å•').length;
            const processingCount = allOrders.filter(o => o.status === 'å¤„ç†ä¸­').length;
            const completedCount = allOrders.filter(o => o.status === 'å·²å®Œæˆ').length;
            const canceledCount = allOrders.filter(o => o.status === 'å·²å–æ¶ˆ').length;
            
            console.log('ğŸ“Š ç»Ÿè®¡æ•°æ®æ›´æ–°ï¼ˆå•†å®¶', currentShopId, 'ï¼‰:', {
                æ–°è®¢å•: newCount,
                å¤„ç†ä¸­: processingCount,
                å·²å®Œæˆ: completedCount,
                å·²å–æ¶ˆ: canceledCount,
                æ€»è®¢å•: allOrders.length
            });
            
            document.getElementById('totalOrders').textContent = allOrders.length;
            document.getElementById('newOrders').textContent = newCount;
            document.getElementById('processingOrders').textContent = processingCount;
            
            // æ›´æ–°å¾½ç« 
            document.getElementById('newOrdersBadge').textContent = newCount;
            document.getElementById('processingOrdersBadge').textContent = processingCount;
            document.getElementById('completedOrdersBadge').textContent = completedCount;
            
            // ä¿®å¤ä»Šæ—¥è¥æ”¶ç»Ÿè®¡ï¼šåªç»Ÿè®¡å·²å®Œæˆè®¢å•çš„é‡‘é¢
            const todayRevenue = allOrders
                .filter(order => order.status === 'å·²å®Œæˆ')
                .reduce((sum, order) => {
                    const amount = parseFloat(order.totalAmount) || 0;
                    console.log(`è®¢å• ${order.orderNumber}: çŠ¶æ€=${order.status}, é‡‘é¢=${amount}`);
                    return sum + amount;
                }, 0);
            
            console.log('ğŸ’° ä»Šæ—¥è¥æ”¶ç»Ÿè®¡ï¼ˆå•†å®¶', currentShopId, 'ï¼‰:', {
                å·²å®Œæˆè®¢å•æ•°: completedCount,
                æ€»è¥æ”¶: todayRevenue
            });
            
            document.getElementById('todayRevenue').textContent = 'Â¥' + todayRevenue.toFixed(2);
        }
        
        // ============================================
        // ğŸ”¥ æ¸…ç©ºä»Šæ—¥æ•°æ®å‡½æ•° - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function clearTodayStats() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºä»Šæ—¥æ‰€æœ‰è®¢å•æ•°æ®å—ï¼Ÿ\n\nè¿™å°†ï¼š\n1. åˆ é™¤å½“å‰å•†å®¶æ‰€æœ‰è®¢å•è®°å½•\n2. é‡ç½®å½“å‰å•†å®¶ç»Ÿè®¡è®¡æ•°\n3. ä¸ä¼šå½±å“å…¶ä»–å•†å®¶\n4. æ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            try {
                console.log('ğŸ—‘ï¸ å¼€å§‹æ¸…ç©ºæ‰€æœ‰è®¢å•æ•°æ®ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰...');
                
                const loadingOverlay = document.createElement('div');
                loadingOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.7);
                    z-index: 9999;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    color: white;
                    font-size: 16px;
                `;
                loadingOverlay.innerHTML = `
                    <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                    <p>æ­£åœ¨åˆ é™¤è®¢å•æ•°æ®...</p>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.appendChild(loadingOverlay);
                
                if (isCloudMode && supabaseClient) {
                    // ğŸ”¥ äº‘ç«¯æ¨¡å¼ï¼šåˆ é™¤å½“å‰å•†å®¶çš„æ‰€æœ‰è®¢å•
                    console.log('ğŸŒ ä»äº‘ç«¯åˆ é™¤æ‰€æœ‰è®¢å•ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰...');
                    
                    // ç›´æ¥åˆ é™¤å½“å‰å•†å®¶çš„æ‰€æœ‰è®¢å•
                    const { error: deleteError } = await supabaseClient
                        .from('orders')
                        .delete()
                        .eq('tenant_id', currentShopId); // åªåˆ é™¤å½“å‰å•†å®¶çš„è®¢å•
                    
                    if (deleteError) {
                        console.error('âŒ åˆ é™¤è®¢å•å¤±è´¥:', deleteError);
                        showToast('âŒ åˆ é™¤è®¢å•å¤±è´¥: ' + deleteError.message, 'error');
                    } else {
                        console.log('âœ… åˆ é™¤è®¢å•æˆåŠŸ');
                        showToast('âœ… æˆåŠŸåˆ é™¤å½“å‰å•†å®¶æ‰€æœ‰è®¢å•', 'success');
                    }
                    
                } else {
                    // ğŸ”¥ æœ¬åœ°æ¨¡å¼ï¼šæ¸…é™¤å½“å‰å•†å®¶çš„æœ¬åœ°å­˜å‚¨è®¢å•
                    console.log('ğŸ“ æ¸…é™¤æœ¬åœ°è®¢å•æ•°æ®ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰...');
                    
                    // åªåˆ é™¤å½“å‰å•†å®¶çš„è®¢å•
                    const remainingOrders = localOrders.filter(order => order.tenant_id !== currentShopId);
                    localStorage.setItem('localOrders', JSON.stringify(remainingOrders));
                    localOrders = remainingOrders;
                    
                    showToast('âœ… æœ¬åœ°è®¢å•æ•°æ®å·²æ¸…é™¤', 'success');
                }
                
                // ğŸ”¥ æ¸…é™¤å†…å­˜ä¸­çš„æ•°æ®
                allOrders = [];
                
                // ğŸ”¥ é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('newOrders').textContent = '0';
                document.getElementById('processingOrders').textContent = '0';
                document.getElementById('todayRevenue').textContent = 'Â¥0.00';
                
                // ğŸ”¥ é‡ç½®å¾½ç« 
                document.getElementById('newOrdersBadge').textContent = '0';
                document.getElementById('processingOrdersBadge').textContent = '0';
                document.getElementById('completedOrdersBadge').textContent = '0';
                
                // ğŸ”¥ åˆ·æ–°è®¢å•åˆ—è¡¨æ˜¾ç¤º
                setTimeout(() => {
                    displayOrders();
                    updateStats();
                }, 500);
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                setTimeout(() => {
                    loadingOverlay.remove();
                }, 1000);
                
                console.log('âœ… æ¸…ç©ºæ“ä½œå®Œæˆï¼ˆå•†å®¶:', currentShopId, ')');
                
            } catch (error) {
                console.error('âŒ æ¸…ç©ºæ“ä½œå¤±è´¥:', error);
                showToast('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message, 'error');
                
                // ç¡®ä¿ç§»é™¤åŠ è½½åŠ¨ç”»
                document.querySelectorAll('[style*="position: fixed; top: 0; left: 0"]').forEach(el => el.remove());
            }
        }
        
        // ============================================
        // æµ‹è¯•è¿æ¥å‡½æ•° - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function testConnection() {
            const testStatus = document.getElementById('testStatus');
            testStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';
            
            try {
                // é‡æ–°åˆå§‹åŒ–è¿æ¥
                await initSupabase();
                
                if (isCloudMode) {
                    testStatus.innerHTML = '<span style="color:#4CAF50"><i class="fas fa-check-circle"></i> è¿æ¥æˆåŠŸ</span>';
                    showToast('âœ… Supabaseè¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                    
                    // é‡æ–°åŠ è½½æ¨èèœå“
                    await loadRecommendations();
                } else {
                    testStatus.innerHTML = '<span style="color:#f44336"><i class="fas fa-times-circle"></i> è¿æ¥å¤±è´¥</span>';
                }
                
            } catch (error) {
                testStatus.innerHTML = '<span style="color:#f44336"><i class="fas fa-times-circle"></i> æµ‹è¯•å¤±è´¥</span>';
                showToast('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ============================================
        // åˆ›å»ºæµ‹è¯•è®¢å• - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function createTestOrder() {
            if (!isCloudMode || !supabaseClient) {
                showToast('å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œæ— æ³•åˆ›å»ºæµ‹è¯•è®¢å•', 'warning');
                return;
            }
            
            try {
                // æ ¹æ®ä½ çš„è¡¨ç»“æ„åˆ›å»ºæµ‹è¯•è®¢å• - æ·»åŠ tenant_id
                const testOrder = {
                    order_number: 'TEST' + Date.now(),
                    table: 'æµ‹è¯•æ¡Œ',
                    dishes: 'æµ‹è¯•èœå“ Ã— 1 = Â¥10.00',
                    total_amount: 10,
                    status: 'æ–°è®¢å•',
                    order_time: new Date().toLocaleString('zh-CN'),
                    timestamp: Date.now(),
                    tenant_id: currentShopId // å¤šå•†å®¶æ”¯æŒ
                };
                
                console.log('æµ‹è¯•è®¢å•æ•°æ®ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰:', testOrder);
                
                const { data, error } = await supabaseClient
                    .from('orders')
                    .insert([testOrder])
                    .select();
                
                if (error) {
                    console.error('âŒ åˆ›å»ºæµ‹è¯•è®¢å•å¤±è´¥:', error);
                    showToast('âŒ åˆ›å»ºæµ‹è¯•è®¢å•å¤±è´¥: ' + error.message, 'error');
                    return;
                }
                
                console.log('âœ… æµ‹è¯•è®¢å•åˆ›å»ºæˆåŠŸï¼ˆå•†å®¶:', currentShopId, 'ï¼‰:', data[0]);
                showToast('âœ… æµ‹è¯•è®¢å•åˆ›å»ºæˆåŠŸ', 'success');
                
                // åˆ·æ–°è®¢å•åˆ—è¡¨
                setTimeout(() => loadOrders(), 1000);
                
            } catch (error) {
                console.error('âŒ åˆ›å»ºæµ‹è¯•è®¢å•å¤±è´¥:', error);
                showToast('âŒ åˆ›å»ºæµ‹è¯•è®¢å•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ============================================
        // æŸ¥çœ‹æœ¬åœ°è®¢å• - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        function showLocalOrders() {
            // è¿‡æ»¤å½“å‰å•†å®¶çš„æœ¬åœ°è®¢å•
            allOrders = localOrders.filter(order => order.tenant_id === currentShopId);
            displayOrders();
            updateStats();
            showToast(`æ˜¾ç¤º ${allOrders.length} ä¸ªæœ¬åœ°è®¢å•ï¼ˆå•†å®¶: ${currentShopConfig.name}ï¼‰`, 'info');
        }
        
        // ============================================
        // æ¨èèœå“ç®¡ç†å‡½æ•° - å¤šå•†å®¶æ”¯æŒ
        // ============================================
        async function loadRecommendations() {
            try {
                console.log('ğŸ“‹ åŠ è½½æ¨èèœå“ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰...');
                
                if (!isCloudMode || !supabaseClient) {
                    console.log('ğŸ“ å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œæ— æ³•ç®¡ç†æ¨èèœå“');
                    document.getElementById('recommendCount').textContent = '0';
                    return;
                }
                
                // åªåŠ è½½å½“å‰å•†å®¶çš„æ¨èèœå“
                const { data, error } = await supabaseClient
                    .from('recommendations')
                    .select('*')
                    .eq('tenant_id', currentShopId) // å¤šå•†å®¶æ”¯æŒ
                    .order('sort_order', { ascending: true });
                
                if (error) {
                    console.error('âŒ åŠ è½½æ¨èèœå“å¤±è´¥:', error);
                    showToast('åŠ è½½æ¨èèœå“å¤±è´¥', 'error');
                    document.getElementById('recommendCount').textContent = '0';
                    return;
                }
                
                allRecommendations = data || [];
                console.log('âœ… åŠ è½½åˆ°æ¨èèœå“ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰:', allRecommendations.length, 'ä¸ª');
                
                // æ›´æ–°è®¡æ•°
                document.getElementById('recommendCount').textContent = allRecommendations.length;
                
                // æ˜¾ç¤ºæ¨èåˆ—è¡¨
                displayRecommendations();
                
            } catch (error) {
                console.error('âŒ åŠ è½½æ¨èèœå“å¼‚å¸¸:', error);
                document.getElementById('recommendCount').textContent = '0';
            }
        }
        
        function displayRecommendations() {
            const container = document.getElementById('recommendList');
            if (!container) return;
            
            if (allRecommendations.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-star"></i>
                        <p>æš‚æ— æ¨èèœå“</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">æ·»åŠ çš„æ¨èèœå“å°†æ˜¾ç¤ºåœ¨é¡¾å®¢ç«¯é¦–é¡µ</p>
                        <p style="font-size: 12px; color: #999; margin-top: 5px;">å½“å‰å•†å®¶: ${currentShopConfig.name}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allRecommendations.map(item => `
                <div class="recommend-item" data-id="${item.id}">
                    <div class="recommend-info">
                        <div>
                            <span class="recommend-name">${item.name}</span>
                            <span class="recommend-price">Â¥${item.price}</span>
                        </div>
                        ${item.description ? `<div class="recommend-description">${item.description}</div>` : ''}
                        <div style="font-size: 11px; color: #999; margin-top: 3px;">
                            æ’åº: ${item.sort_order || 0} | åˆ›å»º: ${new Date(item.created_at).toLocaleDateString('zh-CN')}
                        </div>
                    </div>
                    <div class="recommend-actions">
                        <button class="btn-edit" onclick="editRecommendation('${item.id}')">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button class="btn-delete" onclick="deleteRecommendation('${item.id}')">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        async function saveRecommendation() {
            const name = document.getElementById('recommendName').value.trim();
            const price = document.getElementById('recommendPrice').value.trim();
            const description = document.getElementById('recommendDesc').value.trim();
            const sortOrder = parseInt(document.getElementById('recommendSort').value) || 0;
            
            if (!name || !price) {
                showToast('è¯·å¡«å†™èœå“åç§°å’Œä»·æ ¼', 'warning');
                return;
            }
            
            if (isNaN(parseFloat(price)) || parseFloat(price) <= 0) {
                showToast('ä»·æ ¼å¿…é¡»æ˜¯æ­£æ•°', 'warning');
                return;
            }
            
            try {
                const recommendData = {
                    name: name,
                    price: parseFloat(price),
                    sort_order: sortOrder,
                    updated_at: new Date().toISOString(),
                    tenant_id: currentShopId // å¤šå•†å®¶æ”¯æŒ
                };
                
                if (description) {
                    recommendData.description = description;
                }
                
                let result;
                
                if (editingRecommendId) {
                    // æ›´æ–°ç°æœ‰æ¨è - ç¡®ä¿åªèƒ½æ›´æ–°å½“å‰å•†å®¶çš„æ¨è
                    console.log('ğŸ”„ æ›´æ–°æ¨èèœå“ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰:', editingRecommendId);
                    const { data, error } = await supabaseClient
                        .from('recommendations')
                        .update(recommendData)
                        .eq('id', editingRecommendId)
                        .eq('tenant_id', currentShopId) // å¤šå•†å®¶æ”¯æŒï¼šç¡®ä¿åªèƒ½æ›´æ–°å½“å‰å•†å®¶çš„æ¨è
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                    showToast('æ¨èèœå“æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    // æ–°å¢æ¨è - æ·»åŠ tenant_id
                    console.log('â• æ–°å¢æ¨èèœå“ï¼ˆå•†å®¶:', currentShopId, ')');
                    recommendData.created_at = new Date().toISOString();
                    
                    const { data, error } = await supabaseClient
                        .from('recommendations')
                        .insert([recommendData])
                        .select();
                    
                    if (error) throw error;
                    result = data[0];
                    showToast('æ¨èèœå“æ·»åŠ æˆåŠŸ', 'success');
                }
                
                // é‡æ–°åŠ è½½æ¨èåˆ—è¡¨
                await loadRecommendations();
                
                // æ¸…ç©ºè¡¨å•
                clearRecommendForm();
                
                // é‡ç½®ç¼–è¾‘çŠ¶æ€
                editingRecommendId = null;
                
            } catch (error) {
                console.error('âŒ ä¿å­˜æ¨èèœå“å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function editRecommendation(id) {
            const item = allRecommendations.find(r => r.id === id);
            if (!item) return;
            
            editingRecommendId = id;
            
            document.getElementById('recommendName').value = item.name || '';
            document.getElementById('recommendPrice').value = item.price || '';
            document.getElementById('recommendDesc').value = item.description || '';
            document.getElementById('recommendSort').value = item.sort_order || 0;
            
            // æ»šåŠ¨åˆ°è¡¨å•
            document.querySelector('.recommend-form').scrollIntoView({ behavior: 'smooth' });
            
            showToast('æ­£åœ¨ç¼–è¾‘æ¨èèœå“', 'info');
        }
        
        async function deleteRecommendation(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨èèœå“å—ï¼Ÿ')) {
                return;
            }
            
            try {
                console.log('ğŸ—‘ï¸ åˆ é™¤æ¨èèœå“ï¼ˆå•†å®¶:', currentShopId, 'ï¼‰:', id);
                
                // ç¡®ä¿åªèƒ½åˆ é™¤å½“å‰å•†å®¶çš„æ¨è
                const { error } = await supabaseClient
                    .from('recommendations')
                    .delete()
                    .eq('id', id)
                    .eq('tenant_id', currentShopId); // å¤šå•†å®¶æ”¯æŒ
                
                if (error) throw error;
                
                showToast('æ¨èèœå“åˆ é™¤æˆåŠŸ', 'success');
                
                // é‡æ–°åŠ è½½æ¨èåˆ—è¡¨
                await loadRecommendations();
                
            } catch (error) {
                console.error('âŒ åˆ é™¤æ¨èèœå“å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function clearRecommendForm() {
            document.getElementById('recommendName').value = '';
            document.getElementById('recommendPrice').value = '';
            document.getElementById('recommendDesc').value = '';
            document.getElementById('recommendSort').value = '0';
            editingRecommendId = null;
            
            showToast('è¡¨å•å·²æ¸…ç©º', 'info');
        }
        
        // ============================================
        // åˆ‡æ¢æ ‡ç­¾é¡µå‡½æ•°ï¼ˆä¿®å¤ï¼šæ­£ç¡®æ˜¾ç¤ºæ¨èç®¡ç†é¡µé¢ï¼‰
        // ============================================
        function switchTab(tabName) {
            currentTab = tabName;
            
            // ç§»é™¤æ‰€æœ‰ active ç±»
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ä½¿ç”¨ data-tab å±æ€§æ¥è¯†åˆ«
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ° activeï¼Œä½¿ç”¨ onclick å†…å®¹åˆ¤æ–­ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
            if (!document.querySelector('.tab.active')) {
                tabButtons.forEach(btn => {
                    const onclickContent = btn.getAttribute('onclick') || '';
                    if (onclickContent.includes(`'${tabName}'`) || onclickContent.includes(`"${tabName}"`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // æ˜¾ç¤ºå¯¹åº”é¡µé¢
            if (tabName === 'recommend') {
                document.getElementById('ordersContainer').style.display = 'none';
                document.getElementById('recommendPage').style.display = 'block';
            } else {
                document.getElementById('ordersContainer').style.display = 'block';
                document.getElementById('recommendPage').style.display = 'none';
                displayOrders();
            }
        }
        
        // ============================================
        // è¾…åŠ©å‡½æ•°
        // ============================================
        function updateConnectionStatus(connected, message = '') {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                if (connected) {
                    statusElement.className = 'connection-status status-connected';
                    statusElement.innerHTML = `<i class="fas fa-circle"></i> ${message || 'äº‘ç«¯å·²è¿æ¥'}`;
                } else {
                    statusElement.className = 'connection-status status-disconnected';
                    statusElement.innerHTML = `<i class="fas fa-circle"></i> ${message || 'è¿æ¥æ–­å¼€'}`;
                }
            }
        }
        
        function updateLastUpdateTime() {
            const element = document.getElementById('lastUpdateTime');
            if (element) {
                element.textContent = new Date().toLocaleTimeString('zh-CN');
            }
        }
        
        function showNewOrderNotification(count) {
            const notification = document.getElementById('newOrderNotification');
            const message = document.getElementById('notificationMessage');
            if (notification && message) {
                message.textContent = `æœ‰ ${count} ä¸ªæ–°è®¢å•åˆ°è¾¾ï¼ˆ${currentShopConfig.name}ï¼‰ï¼`;
                notification.style.display = 'block';
                
                // æ’­æ”¾æç¤ºéŸ³
                playNotificationSound();
                
                // 5ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => hideNotification(), 5000);
            }
        }
        
        function hideNotification() {
            const notification = document.getElementById('newOrderNotification');
            if (notification) {
                notification.style.display = 'none';
            }
        }
        
        function playNotificationSound() {
            try {
                // åˆ›å»ºç®€å•çš„æç¤ºéŸ³
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
            } catch (e) {
                console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½æµè§ˆå™¨ä¸æ”¯æŒ');
            }
        }
        
        function showLoading() {
            const container = document.getElementById('ordersContainer');
            if (container) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>æ­£åœ¨åŠ è½½è®¢å•...</p>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">å½“å‰å•†å®¶: ${currentShopConfig.name}</p>
                    </div>
                `;
            }
        }
        
        function showToast(message, type = 'success') {
            // ç§»é™¤å·²æœ‰çš„toast
            document.querySelectorAll('.toast-message').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#ff9800' : '#f44336'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            const icon = type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†è®¢é˜…
        window.addEventListener('beforeunload', function() {
            if (realtimeSubscription && supabaseClient) {
                supabaseClient.removeChannel(realtimeSubscription);
                console.log('âœ… å·²å…³é—­å®æ—¶è®¢é˜…');
            }
        });
    </script>
</body>
</html>
