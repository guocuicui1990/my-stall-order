<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的摊位 - 扫码点餐</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .cloud-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .cloud-online { background: #4CAF50; }
        .cloud-offline { background: #f44336; }
    </style>
</head>
<body>
    <!-- 云端状态指示器 -->
    <div id="cloudStatus" class="cloud-status cloud-offline">
        <i class="fas fa-cloud"></i> <span>离线模式</span>
    </div>

    <!-- 座位号输入页面 -->
    <div id="seatPage" class="page active">
        <div class="logo-container">
            <i class="fas fa-utensils logo-icon"></i>
            <h1>欢迎光临</h1>
            <p class="subtitle">扫码点餐系统</p>
            <div id="seatCloudStatus" style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.7);">
                <i class="fas fa-circle"></i> 正在连接云端...
            </div>
        </div>
        <div class="input-card">
            <div class="input-group">
                <label for="tableNumber">
                    <i class="fas fa-chair"></i> 请输入桌号
                </label>
                <input type="text" id="tableNumber" placeholder="例如: 1, A2, 打包" maxlength="10" autocomplete="off">
                <div class="quick-tables">
                    <span class="quick-btn" onclick="setQuickTable('1')">1号桌</span>
                    <span class="quick-btn" onclick="setQuickTable('2')">2号桌</span>
                    <span class="quick-btn" onclick="setQuickTable('3')">3号桌</span>
                    <span class="quick-btn" onclick="setQuickTable('打包')">打包</span>
                </div>
            </div>
            <button class="btn-primary" onclick="enterMenu()">
                <i class="fas fa-arrow-right"></i> 开始点餐
            </button>
        </div>
        <div class="footer-info">
            <p><i class="fas fa-info-circle"></i> 请告知服务员您的桌号，稍后送餐到桌</p>
        </div>
    </div>

    <!-- 菜单页面 -->
    <div id="menuPage" class="page">
        <div class="menu-header">
            <div class="header-left">
                <button class="btn-back" onclick="backToSeat()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div>
                    <div class="table-display">
                        <i class="fas fa-chair"></i> 桌号: <span id="currentTableDisplay">-</span>
                    </div>
                    <div class="order-count" id="cartSummary">未选择菜品</div>
                </div>
            </div>
            <div class="cart-icon" onclick="showCart()">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-badge" id="cartBadge">0</span>
            </div>
        </div>

        <!-- 菜品分类 -->
        <div class="category-tabs">
            <div class="categories-container">
                <button class="category-btn active" data-category="all">全部</button>
                <button class="category-btn" data-category="热菜">热菜</button>
                <button class="category-btn" data-category="凉菜">凉菜</button>
                <button class="category-btn" data-category="主食">主食</button>
                <button class="category-btn" data-category="饮料">饮料</button>
            </div>
        </div>

        <!-- 菜品列表 -->
        <div class="dishes-container" id="dishesContainer"></div>

        <!-- 底部购物车栏 -->
        <div class="bottom-cart">
            <div class="cart-preview">
                <div class="cart-info">
                    <span id="totalItems">0个菜品</span>
                    <span class="total-price">总计: ¥<span id="previewTotal">0</span></span>
                </div>
                <button class="btn-checkout" onclick="goToCheckout()" disabled id="checkoutBtnMain">
                    去结算 <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 购物车弹窗 -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shopping-cart"></i> 购物车</h3>
                <button class="btn-close" onclick="hideCart()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="cart-items" id="cartItems"></div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>合计</span>
                    <span class="total-amount">¥<span id="cartTotal">0</span></span>
                </div>
                <div class="cart-actions">
                    <button class="btn-secondary" onclick="clearCart()">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                    <button class="btn-primary" onclick="goToCheckout()" id="checkoutBtnModal" disabled>
                        去结算 <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 结账页面 -->
    <div id="checkoutPage" class="page">
        <div class="checkout-header">
            <button class="btn-back" onclick="backToMenu()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <h2>订单确认</h2>
        </div>

        <div class="order-summary">
            <div class="order-info-card">
                <div class="info-row">
                    <span><i class="fas fa-chair"></i> 桌号</span>
                    <span id="orderTable">-</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-receipt"></i> 订单号</span>
                    <span id="orderNumber">-</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-clock"></i> 时间</span>
                    <span id="orderTime">-</span>
                </div>
                <div class="info-row">
                    <span><i class="fas fa-cloud"></i> 云端状态</span>
                    <span id="cloudStatusIndicator">检查中...</span>
                </div>
            </div>

            <div class="order-items-card">
                <h3><i class="fas fa-list"></i> 订单明细</h3>
                <div id="orderItemsList"></div>
                <div class="order-total-row">
                    <span>应付金额</span>
                    <span class="final-amount">¥<span id="finalAmount">0</span></span>
                </div>
            </div>
        </div>

        <!-- 支付方式 -->
        <div class="payment-section">
            <h3><i class="fas fa-qrcode"></i> 扫码支付</h3>
            <p class="payment-tip">请使用微信或支付宝扫描下方二维码付款</p>
            <div class="qrcode-container">
                <!-- 替换这里的src为你的收款二维码图片URL -->
                <img src="./images/qrcode.jpg" alt="收款码" id="paymentQR">
                <div class="qrcode-overlay">
                    <div class="amount-display">¥<span id="qrcodeAmount">0</span></div>
                </div>
            </div>
            <div class="payment-actions">
                <button class="btn-secondary" onclick="backToMenu()">
                    <i class="fas fa-edit"></i> 修改订单
                </button>
                <button class="btn-success" onclick="submitOrder()" id="submitOrderBtn">
                    <i class="fas fa-paper-plane"></i> 提交订单到厨房
                </button>
            </div>
            <div class="payment-notice">
                <p><i class="fas fa-lightbulb"></i> 提示：支付完成后请点击"提交订单"，订单将自动发送到厨房</p>
            </div>
        </div>
    </div>

    <!-- 订单提交成功页面 -->
    <div id="successPage" class="page">
        <div class="success-container">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2>订单提交成功！</h2>
            <p class="success-message">订单号: <span id="successOrderNumber">-</span></p>
            <p class="success-detail">桌号 <span id="successTable">-</span> 的订单已发送到厨房</p>
            <div class="success-info">
                <div class="info-item">
                    <span>状态</span>
                    <strong class="status-new">新订单</strong>
                </div>
                <div class="info-item">
                    <span>取餐时间</span>
                    <strong>约5-10分钟</strong>
                </div>
                <div class="info-item">
                    <span>云端状态</span>
                    <strong id="successCloudStatus">未知</strong>
                </div>
            </div>
            <button class="btn-primary" onclick="newOrder()">
                <i class="fas fa-plus"></i> 再来一单
            </button>
            <div class="success-footer">
                <p><i class="fas fa-star"></i> 感谢惠顾，请稍候取餐！</p>
            </div>
        </div>
    </div>

    <!-- 加载动画 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p id="loadingText">正在提交订单...</p>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
    // ============================================
    // 全局变量和配置
    // ============================================
    window._cart = [];
    window._dishesData = [
        { id: 1, name: '宫保鸡丁', price: 38, emoji: '🍗', category: '热菜' },
        { id: 2, name: '鱼香肉丝', price: 35, emoji: '🥘', category: '热菜' },
        { id: 3, name: '麻婆豆腐', price: 28, emoji: '🍲', category: '热菜' },
        { id: 4, name: '凉拌黄瓜', price: 15, emoji: '🥒', category: '凉菜' },
        { id: 5, name: '拍黄瓜', price: 12, emoji: '🥗', category: '凉菜' },
        { id: 6, name: '米饭', price: 3, emoji: '🍚', category: '主食' },
        { id: 7, name: '炒饭', price: 18, emoji: '🍛', category: '主食' },
        { id: 8, name: '可乐', price: 8, emoji: '🥤', category: '饮料' },
        { id: 9, name: '雪碧', price: 8, emoji: '🥤', category: '饮料' }
    ];
    
    // Supabase配置
    const SUPABASE_URL = 'https://slonbvmhsxqgpoodwazj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsb25idm1oc3hxZ3Bvb2R3YXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzMyNjQsImV4cCI6MjA4NDYwOTI2NH0.YLZqdnZl1vDTOrT6bzi2ulN1BGRxKGyW30AuccuWJq4';
    
    // Supabase客户端
    window.supabaseClient = null;
    window.isCloudConnected = false;
    
    // ============================================
    // 初始化Supabase连接（页面加载时立即执行）
    // ============================================
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🚀 初始化Supabase连接...');
        await initSupabase();
        initApp();
    });
    
    // 初始化Supabase
    async function initSupabase() {
        try {
            console.log('🌐 尝试连接Supabase...');
            
            // 检查Supabase是否已加载
            if (typeof supabase === 'undefined') {
                console.error('❌ Supabase SDK 未加载');
                updateCloudStatus(false, 'SDK未加载');
                return;
            }
            
            // 1. 初始化客户端
            window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('✅ Supabase 客户端初始化成功');
            
            // 2. 测试连接
            console.log('📊 测试数据库连接...');
            try {
                const { data, error } = await window.supabaseClient
                    .from('orders')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    console.warn('⚠️ 数据库连接测试失败:', error.message);
                    
                    if (error.message.includes('relation') || error.message.includes('不存在')) {
                        console.log('💡 orders表可能不存在，需要先创建');
                        updateCloudStatus(false, '表不存在');
                    } else {
                        updateCloudStatus(false, '连接失败');
                    }
                } else {
                    console.log('✅ 数据库连接测试成功，已有订单数:', data.length);
                    window.isCloudConnected = true;
                    updateCloudStatus(true, '云端已连接');
                    
                    // 更新座位页面的状态显示
                    const seatStatus = document.getElementById('seatCloudStatus');
                    if (seatStatus) {
                        seatStatus.innerHTML = '<i class="fas fa-circle" style="color:#4CAF50"></i> 云端已连接';
                    }
                }
                
            } catch (dbError) {
                console.warn('⚠️ 数据库连接测试异常:', dbError.message);
                updateCloudStatus(false, '连接异常');
            }
            
        } catch (error) {
            console.error('❌ Supabase初始化失败:', error);
            updateCloudStatus(false, error.message);
        }
    }
    
    // 更新云端状态显示
    function updateCloudStatus(connected, message = '') {
        window.isCloudConnected = connected;
        
        const statusElement = document.getElementById('cloudStatus');
        const statusText = document.querySelector('#cloudStatus span');
        const cloudStatusIndicator = document.getElementById('cloudStatusIndicator');
        const submitOrderBtn = document.getElementById('submitOrderBtn');
        
        if (statusElement) {
            statusElement.className = connected ? 'cloud-status cloud-online' : 'cloud-status cloud-offline';
            statusText.textContent = connected ? '云端已连接' : `离线模式${message ? ': ' + message : ''}`;
        }
        
        if (cloudStatusIndicator) {
            cloudStatusIndicator.textContent = connected ? '云端已连接' : `离线模式${message ? ': ' + message : ''}`;
            cloudStatusIndicator.style.color = connected ? '#4CAF50' : '#f44336';
        }
        
        if (submitOrderBtn) {
            submitOrderBtn.innerHTML = connected ? 
                '<i class="fas fa-paper-plane"></i> 提交订单到厨房' : 
                '<i class="fas fa-exclamation-triangle"></i> 提交订单（离线模式）';
        }
    }
    
    // ============================================
    // 应用初始化
    // ============================================
    function initApp() {
        console.log('✅ 应用初始化');
        
        // 设置全局变量
        window.currentTable = '';
        window.currentOrderNumber = '';
        
        // 加载菜品
        loadDishesNow();
        setupCategoryButtons();
        
        // 设置键盘事件
        const tableInput = document.getElementById('tableNumber');
        if (tableInput) {
            tableInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enterMenu();
                }
            });
        }
        
        console.log('✅ 应用初始化完成');
    }
    
    // ============================================
    // 界面交互函数
    // ============================================
    window.setQuickTable = function(tableNum) {
        document.getElementById('tableNumber').value = tableNum;
    };
    
    window.enterMenu = function() {
        var tableNum = document.getElementById('tableNumber').value.trim();
        if (!tableNum) {
            alert('请输入桌号');
            return;
        }
        
        // 生成订单号
        var now = new Date();
        var year = now.getFullYear().toString().slice(-2);
        var month = String(now.getMonth() + 1).padStart(2, '0');
        var day = String(now.getDate()).padStart(2, '0');
        var hour = String(now.getHours()).padStart(2, '0');
        var minute = String(now.getMinutes()).padStart(2, '0');
        var second = String(now.getSeconds()).padStart(2, '0');
        var random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        var orderNumber = year + month + day + hour + minute + second + random;
        
        window.currentTable = tableNum;
        window.currentOrderNumber = orderNumber;
        
        document.getElementById('currentTableDisplay').textContent = tableNum;
        switchPage('seatPage', 'menuPage');
        
        setTimeout(function() { 
            loadDishesNow();
            setupCategoryButtons();
        }, 50);
    };
    
    function loadDishesNow() {
        var container = document.getElementById('dishesContainer');
        if (!container) return;
        
        var filteredDishes = window._dishesData;
        var currentCategory = getCurrentCategory();
        
        if (currentCategory && currentCategory !== 'all') {
            filteredDishes = window._dishesData.filter(dish => dish.category === currentCategory);
        }
        
        var html = filteredDishes.map(function(dish) {
            var cartItem = window._cart.find(function(item) { return item.id === dish.id; });
            var quantity = cartItem ? cartItem.quantity : 0;
            return '<div class="dish-card">' +
                '<div style="width:80px;height:80px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:40px;">' +
                    dish.emoji +
                '</div>' +
                '<div class="dish-info">' +
                    '<div class="dish-name">' + dish.name + '</div>' +
                    '<div class="dish-price">¥' + dish.price + '</div>' +
                    '<div class="dish-actions">' +
                        '<button onclick="quickRemoveDish(' + dish.id + ')" style="opacity:' + (quantity === 0 ? '0.3' : '1') + '">' +
                            '<i class="fas fa-minus"></i>' +
                        '</button>' +
                        '<span class="dish-quantity">' + quantity + '</span>' +
                        '<button onclick="quickAddDish(' + dish.id + ')">' +
                            '<i class="fas fa-plus"></i>' +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }).join('');
        
        container.innerHTML = html;
    }
    
    function getCurrentCategory() {
        var activeBtn = document.querySelector('.category-btn.active');
        return activeBtn ? activeBtn.dataset.category : 'all';
    }
    
    function setupCategoryButtons() {
        document.querySelectorAll('.category-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(function(b) {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                loadDishesNow();
            });
        });
    }
    
    window.quickAddDish = function(dishId) {
        var dish = window._dishesData.find(function(d) { return d.id === dishId; });
        if (!dish) return;
        
        var cartItem = window._cart.find(function(item) { return item.id === dishId; });
        
        if (cartItem) {
            cartItem.quantity++;
        } else {
            window._cart.push({ 
                id: dish.id, 
                name: dish.name, 
                price: dish.price, 
                quantity: 1 
            });
        }
        
        updateCartUIQuick();
        loadDishesNow();
    };
    
    window.quickRemoveDish = function(dishId) {
        var cartItem = window._cart.find(function(item) { return item.id === dishId; });
        if (!cartItem) return;
        
        if (cartItem.quantity > 1) {
            cartItem.quantity--;
        } else {
            window._cart = window._cart.filter(function(item) { return item.id !== dishId; });
        }
        
        updateCartUIQuick();
        loadDishesNow();
    };
    
    function updateCartUIQuick() {
        var totalItems = window._cart.reduce(function(sum, item) { return sum + item.quantity; }, 0);
        var totalPrice = window._cart.reduce(function(sum, item) { return sum + (item.price * item.quantity); }, 0);
        
        document.getElementById('cartBadge').textContent = totalItems;
        
        var cartSummary = document.getElementById('cartSummary');
        if (cartSummary) {
            cartSummary.textContent = totalItems > 0 ? '已选 ' + totalItems + ' 个菜品' : '未选择菜品';
        }
        
        document.getElementById('totalItems').textContent = totalItems + '个菜品';
        document.getElementById('previewTotal').textContent = totalPrice.toFixed(2);
        document.getElementById('cartTotal').textContent = totalPrice.toFixed(2);
        
        var checkoutBtnMain = document.getElementById('checkoutBtnMain');
        var checkoutBtnModal = document.getElementById('checkoutBtnModal');
        if (checkoutBtnMain) checkoutBtnMain.disabled = totalItems === 0;
        if (checkoutBtnModal) checkoutBtnModal.disabled = totalItems === 0;
        
        updateCartModalQuick();
    }
    
    function updateCartModalQuick() {
        var cartItemsContainer = document.getElementById('cartItems');
        if (!cartItemsContainer) return;
        
        if (window._cart.length === 0) {
            cartItemsContainer.innerHTML = '<div class="empty-cart">' +
                '<i class="fas fa-shopping-cart"></i>' +
                '<p>购物车是空的</p>' +
            '</div>';
            return;
        }
        
        cartItemsContainer.innerHTML = window._cart.map(function(item) {
            return '<div class="cart-item">' +
                '<div class="item-info">' +
                    '<div class="item-name">' + item.name + '</div>' +
                    '<div class="item-price">¥' + item.price + ' × ' + item.quantity + '</div>' +
                '</div>' +
                '<div class="item-actions">' +
                    '<button onclick="quickRemoveDish(' + item.id + ')">' +
                        '<i class="fas fa-minus"></i>' +
                    '</button>' +
                    '<span>' + item.quantity + '</span>' +
                    '<button onclick="quickAddDish(' + item.id + ')">' +
                        '<i class="fas fa-plus"></i>' +
                    '</button>' +
                '</div>' +
            '</div>';
        }).join('');
    }
    
    window.showCart = function() {
        document.getElementById('cartModal').classList.add('active');
        updateCartModalQuick();
    };
    
    window.hideCart = function() {
        document.getElementById('cartModal').classList.remove('active');
    };
    
    window.clearCart = function() {
        if (!window._cart || window._cart.length === 0) return;
        if (confirm('确定要清空购物车吗？')) {
            window._cart = [];
            updateCartUIQuick();
            loadDishesNow();
        }
    };
    
    window.backToSeat = function() {
        if (window._cart && window._cart.length > 0) {
            if (!confirm('返回将清空购物车，确定要返回吗？')) return;
            window._cart = [];
            updateCartUIQuick();
        }
        switchPage('menuPage', 'seatPage');
        document.getElementById('tableNumber').value = '';
    };
    
    window.goToCheckout = function() {
        if (!window._cart || window._cart.length === 0) {
            alert('请先选择菜品');
            return;
        }
        
        if (window.hideCart) window.hideCart();
        
        document.getElementById('orderTable').textContent = window.currentTable || '-';
        document.getElementById('orderNumber').textContent = window.currentOrderNumber || '-';
        document.getElementById('orderTime').textContent = new Date().toLocaleString('zh-CN');
        
        var orderItemsList = document.getElementById('orderItemsList');
        if (orderItemsList) {
            orderItemsList.innerHTML = window._cart.map(function(item) {
                return '<div class="order-item-row">' +
                    '<span>' + item.name + ' × ' + item.quantity + '</span>' +
                    '<span>¥' + (item.price * item.quantity).toFixed(2) + '</span>' +
                '</div>';
            }).join('');
        }
        
        var totalAmount = window._cart.reduce(function(sum, item) { 
            return sum + (item.price * item.quantity); 
        }, 0);
        
        document.getElementById('finalAmount').textContent = totalAmount.toFixed(2);
        document.getElementById('qrcodeAmount').textContent = totalAmount.toFixed(2);
        
        // 🔥 确保金额正确显示
        console.log('订单总金额:', totalAmount.toFixed(2));
        
        // 更新云端状态显示
        updateCloudStatus(window.isCloudConnected, window.isCloudConnected ? '' : '离线模式');
        
        switchPage('menuPage', 'checkoutPage');
    };
    
    window.backToMenu = function() {
        switchPage('checkoutPage', 'menuPage');
    };
    
    // ============================================
    // 🔥 核心修复：提交订单到Supabase（完全适配你的表结构）
    // ============================================
    window.submitOrder = async function() {
        console.log('📤 开始提交订单到Supabase...');
        
        if (!window._cart || window._cart.length === 0) {
            alert('订单中没有菜品');
            return;
        }
        
        var loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('active');
            document.getElementById('loadingText').textContent = '正在提交订单...';
        }
        
        var totalAmount = window._cart.reduce(function(sum, item) { 
            return sum + (item.price * item.quantity); 
        }, 0);
        
        var orderTime = new Date().toLocaleString('zh-CN');
        var dishesString = window._cart.map(function(item) {
            return item.name + ' × ' + item.quantity + ' = ¥' + (item.price * item.quantity).toFixed(2);
        }).join('; ');
        
        // 🔥 构建订单数据 - 完全适配你的表结构
        // 字段名和类型必须与数据库完全一致
        var orderData = {
            table: window.currentTable,          // text类型
            dishes: dishesString,               // text类型
            status: '新订单',                   // text类型
            timestamp: Date.now(),              // int8类型 - 使用Date.now()获取毫秒时间戳
            order_number: window.currentOrderNumber,  // text类型
            total_amount: parseFloat(totalAmount.toFixed(2)),  // float8类型
            order_time: orderTime               // text类型
        };
        
        console.log('📋 订单数据（完全适配表结构）:', orderData);
        console.log('timestamp 类型:', typeof orderData.timestamp, '值:', orderData.timestamp);
        console.log('total_amount 类型:', typeof orderData.total_amount, '值:', orderData.total_amount);
        
        // 尝试提交到Supabase
        if (window.isCloudConnected && window.supabaseClient) {
            console.log('🌐 尝试提交到Supabase数据库...');
            
            try {
                // 插入数据到orders表
                const { data, error } = await window.supabaseClient
                    .from('orders')
                    .insert([orderData])
                    .select();
                
                if (error) {
                    console.error('❌ 提交到Supabase失败:', error);
                    console.error('错误详情:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    
                    // 检查常见错误
                    if (error.message.includes('relation') || error.message.includes('不存在')) {
                        console.log('💡 orders表可能不存在，需要先创建表');
                        showLocalSuccess('数据库表不存在，请先在Supabase创建orders表');
                    } else if (error.message.includes('column')) {
                        // 字段名或类型错误
                        console.log('💡 字段名或类型不匹配，请检查表结构');
                        showLocalSuccess('字段名或类型不匹配: ' + error.message);
                    } else if (error.message.includes('permission') || error.message.includes('权限')) {
                        console.log('💡 权限不足，请检查RLS策略');
                        showLocalSuccess('数据库权限不足: ' + error.message);
                    } else {
                        showLocalSuccess(error.message);
                    }
                    
                } else {
                    console.log('✅ 订单提交成功！数据:', data[0]);
                    console.log('📡 订单已保存到Supabase，商家端应该能看到');
                    
                    // 显示成功页面
                    showSuccessPage(true, '云端提交成功');
                    
                    // 在控制台显示订单信息供商家查看
                    console.log('📋 订单详情（供商家查看）:');
                    console.log('订单号:', window.currentOrderNumber);
                    console.log('桌号:', window.currentTable);
                    console.log('菜品:', dishesString);
                    console.log('总计: ¥', totalAmount.toFixed(2));
                    console.log('时间:', orderTime);
                    console.log('时间戳:', orderData.timestamp);
                }
                
            } catch (cloudError) {
                console.error('❌ 提交到Supabase异常:', cloudError);
                showLocalSuccess(cloudError.message);
            }
        } else {
            console.log('📝 使用离线模式提交');
            showLocalSuccess('云端连接失败');
        }
        
        // 清空购物车
        window._cart = [];
        updateCartUIQuick();
        
        if (loadingOverlay) {
            loadingOverlay.classList.remove('active');
        }
    };
    
    function showSuccessPage(isCloudSuccess = false, message = '') {
        document.getElementById('successOrderNumber').textContent = window.currentOrderNumber;
        document.getElementById('successTable').textContent = window.currentTable;
        
        const successCloudStatus = document.getElementById('successCloudStatus');
        if (successCloudStatus) {
            if (isCloudSuccess) {
                successCloudStatus.textContent = '云端提交成功';
                successCloudStatus.style.color = '#4CAF50';
            } else {
                successCloudStatus.textContent = '离线模式' + (message ? ': ' + message : '');
                successCloudStatus.style.color = '#f44336';
            }
        }
        
        switchPage('checkoutPage', 'successPage');
    };
    
    function showLocalSuccess(errorMessage = '') {
        // 保存到本地存储作为备份
        try {
            let localOrders = JSON.parse(localStorage.getItem('localOrders') || '[]');
            
            const orderData = {
                id: 'local_' + Date.now(),
                order_number: window.currentOrderNumber,
                table: window.currentTable,
                dishes: window._cart.map(item => item.name + ' × ' + item.quantity).join('; '),
                total_amount: window._cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                status: '新订单',
                order_time: new Date().toLocaleString('zh-CN'),
                timestamp: Date.now(),
                is_local: true
            };
            
            localOrders.push(orderData);
            localStorage.setItem('localOrders', JSON.stringify(localOrders));
            console.log('📝 订单已保存到本地存储');
        } catch (e) {
            console.error('本地存储失败:', e);
        }
        
        // 显示成功页面
        showSuccessPage(false, errorMessage);
        
        // 提示用户
        alert(`订单已提交（离线模式）\n订单号：${window.currentOrderNumber}\n桌号：${window.currentTable}\n\n${errorMessage ? '原因：' + errorMessage : '请告知商家查看控制台获取订单信息'}`);
    };
    
    window.newOrder = function() {
        window.currentTable = '';
        window.currentOrderNumber = '';
        window._cart = [];
        updateCartUIQuick();
        switchPage('successPage', 'seatPage');
        document.getElementById('tableNumber').value = '';
    };
    
    window.addDish = function(dishId) {
        quickAddDish(dishId);
    };
    
    window.removeDish = function(dishId) {
        quickRemoveDish(dishId);
    };
    
    function switchPage(fromPage, toPage) {
        document.getElementById(fromPage).classList.remove('active');
        document.getElementById(toPage).classList.add('active');
    }
    
    console.log('✅ 所有函数已加载完成');
    </script>
</body>
</html>